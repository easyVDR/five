#!/bin/bash
#set -vx
#
#
#  Captain_Beefheart
#
#  v. 0.2     05.08.12 bugfix C.B.
#  v. 0.3     11.02.13 C.B.
#  v. 0.4     22.05.15 michel8
############################################

#################### defines  ##################

. /usr/lib/vdr/easyvdr-config-loader
. /usr/lib/vdr/functions/easyvdr-functions-lib
. /usr/share/easyvdr/setup/easyvdr-setup-defines
. /usr/share/easyvdr/setup/easyvdr-setup-functions

FILENAME="easyvdr-post_detect"
FILEVERSION="V 0.4 vom 22.05.2015"
LOGFILE="$EASYVDR_LOGDIR/easyvdr-HW-detect.log"             # eigenes logfile
RUN_FLAG=$1
UDEV_FLAG=$2

echo " "                                                                  >> $LOGFILE
echo "-------------------------------------------------- "                >> $LOGFILE
echo "File-Info: $FILENAME $FILEVERSION"                                  >> $LOGFILE
log --silent "Hardware Erkennung ($FILENAME $RUN_FLAG) gestartet..."

. $DETECT/chk-lib
HW_POST_INSTALL_SCRIPT="$DETECT/easyvdr-detect_post_install"

#########################  functions   ############################
#####
Detect_FB_KEYMAP()
{
. $CFG_DIR/sysconfig
LS_No=1
while  [[ "${hw_ident[$LS_No]}" != "FINITO" ]] 
  do
    HW_NAME="${hw_name[$LS_No]}"
    MOD_HW_NAME="${HW_NAME// /_}"       # Leerzeichen durch "_" ersetzen
     if [[ X"$MOD_HW_NAME" == X"$FB_RECEIVER" ]]; then
        CH_INDEX=$LS_No
        break
      fi
    ((++LS_No))
  done	                                 # Ende der Listenelemente erreicht
unset hw_ident
}

#################################
Do_Install_Keymap()
{
HW_NAME_SEL="${hw_name[$CH_INDEX]}"
TRA_PARAM="FB_CONTROLLER"
INS_METHOD="inst_keymap"                    # Inst fuer einzelnes Element der Library
PARASET_A="${paraset_a[$CH_INDEX]}"         # ausgewaeltes Element
PARASET_B="${paraset_b[$CH_INDEX]}"
PARASET_C="${paraset_c[$CH_INDEX]}"
PARASET_D="${paraset_d[$CH_INDEX]}"

log --silent "  -> $HW_NAME_SEL Ausgewaehlt, ToDo siehe $HW_POST_INSTALL_SCRIPT"

echo "# Fuer die Keymaps ist folgendes zu tun:"                                                       >> $HW_POST_INSTALL_SCRIPT
echo "$INS_METHOD \"${!TRA_PARAM}\" \"$PARASET_A\" \"$PARASET_B\" \"$PARASET_C\" \"$PARASET_D\""      >> $HW_POST_INSTALL_SCRIPT
echo ""                                                                                               >> $HW_POST_INSTALL_SCRIPT
}

#################################
Do_Configure_FB_Receiver()
{
# Konfiguriere fuer besondere FB-Hardware

HW_NAME_SEL="${hw_name[$CH_INDEX]}"
if [ "$HW_NAME_SEL" == "Atric IR Wakeup USB" ]; then
    echo "# Fuer den Atric-USB ist folgendes zu tun:"                                                  >> $HW_POST_INSTALL_SCRIPT
    echo "$SETUP/hw-setup/Remot_Atric_IR_Wakeup_USB"                                                   >> $HW_POST_INSTALL_SCRIPT
    echo ""                                                                                            >> $HW_POST_INSTALL_SCRIPT
fi

}

#####
Write_post_todo_Header()
{
echo "#!/bin/bash"                                                                             > $HW_POST_INSTALL_SCRIPT
echo "#set -vx"                                                                               >> $HW_POST_INSTALL_SCRIPT
echo "#"                                                                                      >> $HW_POST_INSTALL_SCRIPT
echo "# Automatically generated by easyvdr-post-detect"                                       >> $HW_POST_INSTALL_SCRIPT
echo "#"                                                                                      >> $HW_POST_INSTALL_SCRIPT
echo "###########################################"                                            >> $HW_POST_INSTALL_SCRIPT
echo ""                                                                                       >> $HW_POST_INSTALL_SCRIPT
echo ". /usr/lib/vdr/easyvdr-config-loader"                                                   >> $HW_POST_INSTALL_SCRIPT
echo ". /usr/lib/vdr/functions/easyvdr-functions-lib"                                         >> $HW_POST_INSTALL_SCRIPT
echo ". $SETUP/easyvdr-setup-defines"                                                         >> $HW_POST_INSTALL_SCRIPT
echo ". $DETECT/inst-lib"                                                                     >> $HW_POST_INSTALL_SCRIPT
echo ""                                                                                       >> $HW_POST_INSTALL_SCRIPT
echo "LOGFILE=\"$EASYVDR_LOGDIR/easyvdr-HW-detect_install.log\""                              >> $HW_POST_INSTALL_SCRIPT
echo "log --silent \"automatically generated script easyvdr-detect_post_install gestartet\""  >> $HW_POST_INSTALL_SCRIPT
echo ""                                                                                       >> $HW_POST_INSTALL_SCRIPT
}

#####
Write_post_todo_Tail()
{
echo "log --silent \"easyvdr-detect_post_install beendet\""                                   >> $HW_POST_INSTALL_SCRIPT
chmod 755 $HW_POST_INSTALL_SCRIPT

log --silent "$HW_POST_INSTALL_SCRIPT geschrieben:"
echo "=======================================================================================" >> $LOGFILE
cat $HW_POST_INSTALL_SCRIPT >> $LOGFILE
echo "=======================================================================================" >> $LOGFILE
log --silent " "
}


#################################### Main Runs ################################################

#####
Run_FB_CTRL()
{
hw_lib="$DETECT/hw-lib/40_remote_control_receiver"
. $hw_lib                                                      # aktuelle lib aus ./hw-lib reinholen

Write_post_todo_Header                                        # Kopf vom ToDo-Script schreiben:
  Detect_FB_KEYMAP
  Do_Install_Keymap
  Do_Configure_FB_Receiver
Write_post_todo_Tail                                          # ToDo-Script abschliessen:
Run_Post_Inst
}

######
Run_Post_Inst()
{

log --silent "Starte $HW_POST_INSTALL_SCRIPT..."
if [ -f $DETECT/easyvdr-detect_post_install ]; then
  $DETECT/easyvdr-detect_post_install
fi

[[ $UDEV_FLAG == "-RUN_UDEV" ]] && { echo "$DETECT/udev-reloader" | at now >/dev/null 2>&1; }

echo " " >> $LOGFILE
log --silent "... zurueck in easyvdr-detect..."
}

######################################## Main ###################################################

case $RUN_FLAG in
    -Fb_Contr) Run_FB_CTRL         ;;
            *) echo "nix"          ;;
esac

log --silent "$FILENAME fertig durchgelaufen."

